(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,52683,e=>{"use strict";var t=e.i(43476),s=e.i(71645);let n=()=>"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2),i=e=>({id:e??n(),title:"新的对话",messages:[],createdAt:Date.now(),isCustomTitle:!1}),a=e=>{if(!e)return"";try{return new Intl.DateTimeFormat("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).format(e)}catch{return""}},r=e=>e.messages.filter(e=>!e.isThinking&&e.content.trim().length>0).map(e=>{let t={role:e.role,content:e.content};return e.tool_call_id&&(t.tool_call_id=e.tool_call_id),t}),l=({children:e})=>(0,t.jsx)("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",children:e}),c=()=>(0,t.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",children:[(0,t.jsx)("rect",{x:"5",y:"8",width:"14",height:"10",rx:"3"}),(0,t.jsx)("circle",{cx:"9",cy:"13",r:"1"}),(0,t.jsx)("circle",{cx:"15",cy:"13",r:"1"})]}),o=()=>(0,t.jsxs)(l,{children:[(0,t.jsx)("path",{d:"M12 20h9"}),(0,t.jsx)("path",{d:"M16.5 3.5l4 4L7 21H3v-4L16.5 3.5z"})]}),d=()=>(0,t.jsxs)(l,{children:[(0,t.jsx)("path",{d:"M3 6h18"}),(0,t.jsx)("path",{d:"M8 6V4h8v2"}),(0,t.jsx)("path",{d:"M7 6l1 14h8l1-14"}),(0,t.jsx)("path",{d:"M10 10v6"}),(0,t.jsx)("path",{d:"M14 10v6"})]}),h=()=>(0,t.jsx)(l,{children:(0,t.jsx)("path",{d:"M5 13l4 4L19 7"})}),u=()=>(0,t.jsxs)(l,{children:[(0,t.jsx)("path",{d:"M6 6l12 12"}),(0,t.jsx)("path",{d:"M6 18L18 6"})]}),m=()=>(0,t.jsxs)(l,{children:[(0,t.jsx)("path",{d:"M12 3l1.2 3.8 3.8 1.2-3.8 1.2-1.2 3.8-1.2-3.8L7 8l3.8-1.2z"}),(0,t.jsx)("path",{d:"M5 16l.7 2 .7-2 2-.7-2-.6-.7-2-.7 2-2 .6z"}),(0,t.jsx)("path",{d:"M18 15l.6 1.4.6-1.4 1.4-.6-1.4-.6-.6-1.4-.6 1.4-1.4.6z"})]}),x=()=>(0,t.jsx)(l,{children:(0,t.jsx)("path",{d:"M15 6l-6 6 6 6"})}),p=()=>(0,t.jsx)(l,{children:(0,t.jsx)("path",{d:"M9 6l6 6-6 6"})}),j=()=>(0,t.jsxs)(l,{children:[(0,t.jsx)("circle",{cx:"12",cy:"9",r:"3"}),(0,t.jsx)("path",{d:"M6 19c0-2.5 3-4 6-4s6 1.5 6 4"})]}),g=()=>(0,t.jsxs)(l,{children:[(0,t.jsx)("rect",{x:"5",y:"7",width:"14",height:"10",rx:"3"}),(0,t.jsx)("circle",{cx:"9",cy:"12",r:"1"}),(0,t.jsx)("circle",{cx:"15",cy:"12",r:"1"}),(0,t.jsx)("path",{d:"M12 4v3"}),(0,t.jsx)("path",{d:"M8 21h8"})]}),f=()=>(0,t.jsxs)(l,{children:[(0,t.jsx)("rect",{x:"9",y:"9",width:"12",height:"12",rx:"2"}),(0,t.jsx)("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"})]}),b=()=>(0,t.jsxs)(l,{children:[(0,t.jsx)("path",{d:"M22 2 11 13"}),(0,t.jsx)("path",{d:"M22 2 15 22 11 13 2 9z"})]}),v=()=>(0,t.jsx)(l,{children:(0,t.jsx)("rect",{x:"6",y:"6",width:"12",height:"12",rx:"2"})}),y=({href:e})=>(0,t.jsxs)("a",{className:"link-card",href:e,target:"_blank",rel:"noreferrer",children:[(0,t.jsx)("div",{className:"link-card__icon",children:(0,t.jsx)(c,{})}),(0,t.jsxs)("div",{className:"link-card__body",children:[(0,t.jsx)("p",{className:"link-card__title",children:(e=>{try{return new URL(e).hostname.replace(/^www\./,"")}catch{return e}})(e)}),(0,t.jsx)("span",{className:"link-card__url",children:e})]})]});var N=e.i(47167);let k=N.default.env.NEXT_PUBLIC_BACKEND_PORT??"9000",w=()=>{let e=N.default.env.NEXT_PUBLIC_API_BASE_URL?.trim();return e?e.replace(/\/+$/,""):window.location.origin.replace(/\/+$/,"")},C="second_brain_sessions_v1",$=/(https?:\/\/[^\s]+)/gi;function T(){let{sessions:e,activeSession:l,activeSessionId:c,setActiveSessionId:N,inputValue:k,setInputValue:T,hydrated:D,isActivePending:S,createNewSession:_,deleteSession:L,renameSession:R,handleSubmit:B,abortSessionRequest:I}=function(){let e=(0,s.useMemo)(()=>i(),[]),[t,a]=(0,s.useState)([e]),[l,c]=(0,s.useState)(e.id),[o,d]=(0,s.useState)(""),[h,u]=(0,s.useState)({}),[m,x]=(0,s.useState)(!1),p=(0,s.useRef)(new Map),j=(0,s.useRef)(w()),g=(0,s.useRef)(new Map),f=t.find(e=>e.id===l)??t[0]??e,b=!!(f&&h[f.id]),v=Object.values(h).some(Boolean),y=(0,s.useCallback)((e,t)=>{u(s=>{if(t)return s[e]?s:{...s,[e]:!0};if(!s[e])return s;let{[e]:n,...i}=s;return i})},[]),N=(0,s.useCallback)(e=>{let t=p.current.get(e);t&&(t.abort(),p.current.delete(e)),y(e,!1)},[y]);(0,s.useEffect)(()=>{try{let e=localStorage.getItem(C);if(e){let t=JSON.parse(e);Array.isArray(t)&&t.length>0&&(a(t),c(t[0].id))}document.documentElement.dataset.theme="light"}catch(e){console.error("Failed to load sessions",e)}finally{x(!0)}},[e.id]),(0,s.useEffect)(()=>{m&&localStorage.setItem(C,JSON.stringify(t))},[t,m]),(0,s.useEffect)(()=>{m&&(document.documentElement.dataset.theme="light")},[m]),(0,s.useEffect)(()=>()=>{p.current.forEach(e=>e.abort()),p.current.clear()},[]);let k=(0,s.useCallback)((e,t)=>{a(s=>[t(s.find(t=>t.id===e)??i(e)),...s.filter(t=>t.id!==e)])},[]),$=(0,s.useCallback)(()=>{let e=i();a(t=>[e,...t]),c(e.id),d("")},[]),T=(0,s.useCallback)(e=>{N(e),a(t=>{let s=t.filter(t=>t.id!==e);if(0===s.length){let e=i();return c(e.id),[e]}return e===l&&c(s[0].id),s})},[N,l]),E=(0,s.useCallback)((e,t)=>{let s=t.trim()||"新的对话";k(e,e=>({...e,title:s,isCustomTitle:!0}))},[k]),M=(0,s.useCallback)(async(e,s)=>{let n=t.find(t=>t.id===e);if(!n||n.isCustomTitle)return;let i=g.current,a=Date.now();if(!(a-(i.get(e)??0)<5e3)){i.set(e,a);try{let t=j.current||w();j.current=t;let i=s?.length?s:r(n);if(!i.length)return;let a=await fetch(`${t}/chat/title`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:i})});if(!a.ok)throw Error(`生成标题失败: ${a.status}`);let l=await a.json(),c=l.title?.trim();c&&k(e,e=>e.isCustomTitle?e:{...e,title:c})}catch(e){console.warn("自动生成标题失败",e)}}},[t,k]),D=(0,s.useCallback)(()=>{f&&(N(f.id),k(f.id,e=>({...e,messages:[]})))},[N,f,k]),S=(0,s.useCallback)((e,t,s)=>{k(e,e=>e.messages.some(e=>e.id===t)?{...e,messages:e.messages.map(e=>e.id===t?s(e):e)}:e)},[k]),_=(0,s.useCallback)(async e=>{e.preventDefault();let t=o.trim();if(!t||!f)return;let s=f.id;if(h[s])return;let i=[...r(f),{role:"user",content:t}],a=e=>{e.trim()&&M(s,[...i,{role:"assistant",content:e}]).catch(()=>void 0)},l={id:n(),role:"user",content:t,timestamp:Date.now()},c={id:n(),role:"assistant",content:"",isThinking:!0,timestamp:Date.now()};k(s,e=>{let s;return{...e,title:e.messages.length?e.title:(s=t.trim().replace(/\s+/g," "))?s.length>24?`${s.slice(0,24)}...`:s:"新的对话",messages:[...e.messages,l,c]}}),d(""),y(s,!0);let u=new AbortController;p.current.set(s,u);try{let e=j.current||w();j.current=e;let t=await fetch(`${e}/chat/stream`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:i}),signal:u.signal});if(!t.ok){let e=await t.text();throw Error(e||`请求失败: ${t.status}`)}if(!t.body){let e=(await t.text()).trim()||"助手暂时没有回复。";S(s,c.id,t=>({...t,content:e,isThinking:!1,timestamp:Date.now()})),a(e);return}let n=t.body.getReader(),r=new TextDecoder("utf-8"),l="";for(;;){let{value:e,done:t}=await n.read();if(t)break;if(e){let t=r.decode(e,{stream:!0});if(!t)continue;l+=t,S(s,c.id,e=>({...e,content:l,isThinking:!0,timestamp:e.timestamp??Date.now()}))}}let o=((l+=r.decode())||"助手暂时没有回复。").trim();S(s,c.id,e=>({...e,content:o,isThinking:!1,timestamp:Date.now()})),a(o)}catch(t){if(t?.name==="AbortError")return void S(s,c.id,e=>({...e,content:e.content||"（请求已取消）",isThinking:!1,timestamp:Date.now()}));let e=t instanceof Error?t.message:"发生未知错误";S(s,c.id,t=>({...t,content:e,isThinking:!1,isError:!0,timestamp:Date.now()}))}finally{p.current.get(s)===u&&p.current.delete(s),y(s,!1)}},[o,f,h,k,y,d]);return{sessions:t,activeSession:f,activeSessionId:l,setActiveSessionId:c,inputValue:o,setInputValue:d,pendingSessions:h,hydrated:m,isActivePending:b,isAnyPending:v,createNewSession:$,deleteSession:T,renameSession:E,clearActiveSession:D,handleSubmit:_,abortSessionRequest:N,refreshSessionTitle:M}}(),[A,O]=(0,s.useState)(null),[U,P]=(0,s.useState)(""),[K,z]=(0,s.useState)(!1),[F,J]=(0,s.useState)(null),H=(0,s.useRef)(null),V=(0,s.useRef)(null),W=(0,s.useRef)(null),X=l?.messages??[],q=X.length>0,G=X[X.length-1],Q=S&&(!G||!G.content.trim());(0,s.useEffect)(()=>{H.current?.scrollIntoView({behavior:"smooth"})},[X,c]),(0,s.useEffect)(()=>{let e=V.current;e&&(e.style.height="auto",e.style.height=`${Math.min(e.scrollHeight,240)}px`)},[k]),(0,s.useEffect)(()=>()=>{W.current&&window.clearTimeout(W.current)},[]);let Y=()=>{O(null),P("")},Z=(e,t)=>{R(e,t??U),Y()},ee=(0,s.useCallback)((e,t)=>{e&&navigator.clipboard?.writeText(e).then(()=>{J(t),W.current&&window.clearTimeout(W.current),W.current=window.setTimeout(()=>J(null),2e3)}).catch(e=>{console.error("复制失败",e)})},[]);return(0,t.jsx)("main",{className:"screen",children:(0,t.jsxs)("div",{className:`chat-app ${K?"collapsed":""}`,children:[(0,t.jsxs)("aside",{className:`history-panel ${K?"collapsed":""}`,"aria-label":"历史会话",children:[(0,t.jsx)("div",{className:"history-header",children:(0,t.jsxs)("button",{className:"pill-btn primary",onClick:_,children:[(0,t.jsx)(m,{})," 新对话"]})}),(0,t.jsx)("div",{className:"history-scroll",role:"list",children:e.map(e=>{let s,n=D&&(s=(e=>{if(e)return e.messages[e.messages.length-1]?.timestamp??e.createdAt})(e))?a(s):"",i=e.id===l?.id,r=A===e.id,c=["history-item",i?"active":"",r?"renaming":""].filter(Boolean).join(" ");return(0,t.jsxs)("div",{className:c,onClick:()=>N(e.id),role:"button",tabIndex:0,onKeyDown:t=>{("Enter"===t.key||" "===t.key)&&(t.preventDefault(),N(e.id))},children:[(0,t.jsx)("div",{className:"history-text",children:r?(0,t.jsx)("input",{className:"session-title-input",autoFocus:!0,value:U,onClick:e=>e.stopPropagation(),onChange:e=>P(e.target.value),onBlur:()=>Z(e.id,U),onKeyDown:t=>{var s;return s=e.id,void("Enter"===t.key?(t.preventDefault(),Z(s)):"Escape"===t.key&&(t.preventDefault(),Y()))}}):(0,t.jsxs)("div",{className:"history-lines",children:[(0,t.jsx)("p",{className:"session-title",title:e.title,children:e.title}),n&&(0,t.jsx)("time",{className:"session-time",children:n})]})}),(0,t.jsx)("div",{className:"session-actions",onClick:e=>e.stopPropagation(),children:r?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{type:"button",className:"icon-btn",onMouseDown:e=>e.preventDefault(),onClick:()=>Z(e.id,U),"aria-label":"保存名称",children:(0,t.jsx)(h,{})}),(0,t.jsx)("button",{type:"button",className:"icon-btn",onMouseDown:e=>e.preventDefault(),onClick:Y,"aria-label":"取消重命名",children:(0,t.jsx)(u,{})})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{type:"button",className:"icon-btn",onClick:()=>{O(e.id),P(e.title)},title:"重命名","aria-label":"重命名",children:(0,t.jsx)(o,{})}),(0,t.jsx)("button",{type:"button",className:"icon-btn danger",onClick:()=>{var t;return t=e.id,void(window.confirm("确定删除该会话吗？")&&L(t))},title:"删除","aria-label":"删除",children:(0,t.jsx)(d,{})})]})})]},e.id)})}),(0,t.jsx)("div",{className:"history-footer",children:(0,t.jsx)("button",{type:"button",className:"collapse-toggle",onClick:()=>z(e=>!e),"aria-label":K?"展开侧边栏":"收起侧边栏",children:K?(0,t.jsx)(p,{}):(0,t.jsx)(x,{})})})]}),(0,t.jsx)("section",{className:"conversation-shell",children:(0,t.jsxs)("div",{className:"conversation-inner",children:[(0,t.jsxs)("nav",{className:"top-nav",children:[(0,t.jsxs)("div",{className:"title-stack",children:[(0,t.jsx)("div",{className:"logo-mark","aria-hidden":!0,children:(0,t.jsx)(m,{})}),(0,t.jsx)("div",{className:"title-text",children:(0,t.jsx)("h1",{children:"Second Brain"})})]}),(0,t.jsx)("div",{className:"nav-actions",children:S&&l&&(0,t.jsxs)("button",{type:"button",className:"pill-btn subtle",onClick:()=>I(l.id),children:[(0,t.jsx)(v,{})," 停止生成"]})})]}),(0,t.jsxs)("div",{className:"conversation-body",children:[(0,t.jsxs)("section",{className:"chat-feed","aria-live":"polite",children:[q?X.map(e=>{if(e.isError)return(0,t.jsx)("div",{className:"message-error",role:"alert",children:(0,t.jsx)("span",{children:e.content})},e.id);let s="assistant"===e.role&&e.isThinking,n=(e=>{let t;if(!e)return[{type:"text",content:""}];let s=[],n=/```(\w+)?\n?([\s\S]*?)```/g,i=0;for(;null!==(t=n.exec(e));)t.index>i&&s.push({type:"text",content:e.slice(i,t.index)}),s.push({type:"code",language:t[1]?.trim()||"code",content:t[2]?.replace(/^\n/,"").replace(/\n$/,"")??""}),i=n.lastIndex;return i<e.length&&s.push({type:"text",content:e.slice(i)}),s.length?s:[{type:"text",content:e}]})(e.content),i=D?a(e.timestamp):"",r=e.timestamp&&!Number.isNaN(e.timestamp)?new Date(e.timestamp).toISOString():void 0;return(0,t.jsxs)("article",{className:`message-row ${e.role}`,children:[(0,t.jsx)("div",{className:"message-avatar","aria-hidden":!0,children:(0,t.jsx)("div",{className:`avatar ${e.role}`,children:"user"===e.role?(0,t.jsx)(j,{}):(0,t.jsx)(g,{})})}),(0,t.jsxs)("div",{className:"message-stack",children:[(0,t.jsx)("div",{className:"message-bubble",children:(0,t.jsxs)("div",{className:"message-content",children:[n.map((s,n)=>"code"===s.type?(0,t.jsxs)("div",{className:"code-block",children:[(0,t.jsxs)("div",{className:"code-header",children:[(0,t.jsx)("span",{children:s.language}),(0,t.jsx)("button",{type:"button",onClick:()=>ee(s.content,`${e.id}-code-${n}`),"aria-label":"复制代码",children:F===`${e.id}-code-${n}`?"已复制":"复制"})]}),(0,t.jsx)("pre",{children:(0,t.jsx)("code",{children:s.content})})]},`${e.id}-code-${n}`):s.content.split(/\n{2,}/).map((s,i)=>{let a=s.trim();return(e=>{try{let t=e.trim();if(!t)return!1;return!!new URL(t).hostname}catch{return!1}})(a)?(0,t.jsx)(y,{href:a},`${e.id}-link-${n}-${i}`):(0,t.jsx)("p",{children:s.split("\n").map((a,r)=>(0,t.jsxs)("span",{children:[(e=>{let s,n=[],i=0,a=new RegExp($);for(;null!==(s=a.exec(e));){s.index>i&&n.push(e.slice(i,s.index));let a=s[0];n.push((0,t.jsx)("a",{className:"inline-link",href:a,target:"_blank",rel:"noreferrer",children:a.replace(/^https?:\/\//,"").replace(/^www\./,"")},`inline-link-${a}-${s.index}`)),i=s.index+a.length}return i<e.length&&n.push(e.slice(i)),n.length?n:[e]})(a),r<s.split("\n").length-1&&(0,t.jsx)("br",{})]},`${e.id}-line-${n}-${i}-${r}`))},`${e.id}-p-${n}-${i}`)})),!n.length&&s&&(0,t.jsx)("span",{children:" "}),s&&(0,t.jsx)(E,{})]})}),(0,t.jsxs)("div",{className:"message-meta",children:[(0,t.jsx)("div",{className:"bubble-actions",children:(0,t.jsx)("button",{type:"button",className:"bubble-action",onClick:()=>ee(e.content,e.id),disabled:!e.content,"aria-label":"复制消息",children:(0,t.jsx)(f,{})})}),i&&(0,t.jsx)("time",{className:"message-time",dateTime:r,children:i})]})]})]},e.id)}):(0,t.jsxs)("div",{className:"empty-state",children:[(0,t.jsx)("p",{children:"提出你的第一个问题，让 Second Brain 协助你梳理想法。"}),(0,t.jsxs)("button",{className:"text-btn",type:"button",onClick:_,children:[(0,t.jsx)(m,{})," 发起对话"]})]}),Q&&(0,t.jsx)(M,{message:"正在生成回答…"}),(0,t.jsx)("div",{ref:H})]}),(0,t.jsx)("form",{className:"composer",onSubmit:B,children:(0,t.jsxs)("div",{className:"composer-field",children:[(0,t.jsx)("textarea",{ref:V,placeholder:S?"等待当前回复完成...":"输入你的问题，Shift+Enter 换行",value:k,onChange:e=>T(e.target.value),onKeyDown:e=>{let t=e.nativeEvent?.isComposing;"Enter"!==e.key||e.shiftKey||t||(e.preventDefault(),e.currentTarget.form?.dispatchEvent(new Event("submit",{cancelable:!0,bubbles:!0})))},disabled:S&&!k}),(0,t.jsx)("button",{type:"submit",className:"send-btn","data-ready":!!k.trim()&&!S,disabled:!k.trim()||S,"aria-label":"发送",children:(0,t.jsx)(b,{})})]})})]})]})})]})})}let E=()=>(0,t.jsxs)("span",{className:"thinking","aria-label":"回答生成中",role:"status",children:[(0,t.jsx)("span",{className:"thinking-dot"}),(0,t.jsx)("span",{className:"thinking-dot"}),(0,t.jsx)("span",{className:"thinking-dot"})]}),M=({message:e})=>(0,t.jsxs)("div",{className:"effort-indicator",role:"status","aria-live":"polite",children:[(0,t.jsx)("div",{className:"effort-spinner","aria-hidden":!0}),(0,t.jsx)("p",{children:e})]});e.s(["default",()=>T],52683)}]);